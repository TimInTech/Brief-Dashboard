<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>📬 Brief-Dashboard PRO | TimInTech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    @media print {
      body *:not(#druckbereich):not(#druckbereich *) {
        visibility: hidden;
      }
      #druckbereich, #druckbereich * {
        visibility: visible;
      }
      #druckbereich {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
    .priority-high { background-color: #fee2e2; }
    .priority-medium { background-color: #fef3c7; }
    .priority-low { background-color: #dcfce7; }
    .document-preview {
      max-width: 100px;
      max-height: 60px;
      object-fit: cover;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #stats-container {
      background-color: #f8fafc;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-item {
      margin-bottom: 0.5rem;
    }
    .stat-value {
      font-weight: bold;
      color: #1e40af;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 p-4 md:p-6 max-w-6xl mx-auto">
  <!-- Header mit GitHub Link -->
  <header class="mb-6 flex justify-between items-center border-b pb-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold">📬 Brief-Dashboard PRO</h1>
      <p class="text-gray-600">Lokale Verwaltung Ihrer Post mit Dokumentenarchiv</p>
    </div>
    <a href="https://github.com/TimInTech/Brief-Dashboard" target="_blank" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white" class="mr-2">
        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
      </svg>
      GitHub
    </a>
  </header>

  <!-- Hauptbereich -->
  <div class="grid md:grid-cols-3 gap-6">
    <!-- Linke Spalte - Formular und Statistik -->
    <div class="md:col-span-1 space-y-4">
      <!-- Brief erfassen Formular -->
      <section class="bg-white border border-gray-200 p-4 rounded shadow">
        <h2 class="font-bold mb-3 text-lg">Neuen Brief erfassen</h2>
        <form id="briefForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Datum</label>
            <input type="date" id="datum" class="w-full p-2 border rounded">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Absender</label>
            <input type="text" id="absender" placeholder="Optional" class="w-full p-2 border rounded">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Betreff</label>
            <input type="text" id="betreff" placeholder="Optional" class="w-full p-2 border rounded">
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Betrag (€)</label>
              <input type="number" step="0.01" id="betrag" placeholder="Optional" class="w-full p-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Frist</label>
              <input type="date" id="frist" placeholder="Optional" class="w-full p-2 border rounded">
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Kategorie</label>
            <select id="kategorie" class="w-full p-2 border rounded">
              <option value="">-- Bitte wählen --</option>
              <option>🟥 Gericht / Inkasso</option>
              <option>🟧 Versorger / Banken</option>
              <option>🟨 Behörden / Krankenkassen</option>
              <option>🟩 Werbung / Privat</option>
              <option>🏫 Schule / Beratung</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Status</label>
            <select id="status" class="w-full p-2 border rounded">
              <option>📭 Ungeöffnet</option>
              <option>📖 Geöffnet</option>
              <option>📝 In Bearbeitung</option>
              <option>✅ Erledigt</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Dokumente (PDF/Bild)</label>
            <input type="file" id="dokumente" multiple accept=".pdf,.jpg,.jpeg,.png" class="w-full p-2 border rounded">
            <p class="text-xs text-gray-500 mt-1">Optional: Bis zu 5 Dateien (max. 5MB pro Datei)</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Notizen</label>
            <textarea id="notizen" class="w-full p-2 border rounded" rows="2" placeholder="Optionale Notizen"></textarea>
          </div>
          
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mt-2">
            Eintrag erstellen
          </button>
        </form>
      </section>

      <!-- Statistik -->
      <section class="bg-white border border-gray-200 p-4 rounded shadow" id="stats-container">
        <h2 class="font-bold mb-3 text-lg">📊 Statistiken</h2>
        
        <div class="mb-4">
          <h3 class="font-semibold mb-2">Briefe nach Kategorie:</h3>
          <ul class="space-y-1">
            <li class="stat-item">🟥 Gericht / Inkasso: <span id="catRed" class="stat-value">0</span></li>
            <li class="stat-item">🟧 Versorger / Banken: <span id="catOrange" class="stat-value">0</span></li>
            <li class="stat-item">🟨 Behörde / Krankenkasse: <span id="catYellow" class="stat-value">0</span></li>
            <li class="stat-item">🟩 Werbung / Privat: <span id="catGreen" class="stat-value">0</span></li>
            <li class="stat-item">🏫 Schule / Beratung: <span id="catSchool" class="stat-value">0</span></li>
          </ul>
        </div>
        
        <div class="mb-4">
          <h3 class="font-semibold mb-2">Briefe nach Status:</h3>
          <ul class="space-y-1">
            <li class="stat-item">🔴 offen: <span id="statusOpen" class="stat-value">0</span></li>
            <li class="stat-item">🟡 in Bearbeitung: <span id="statusBearbeitung" class="stat-value">0</span></li>
            <li class="stat-item">🟢 erledigt: <span id="statusErledigt" class="stat-value">0</span></li>
          </ul>
        </div>
        
        <div>
          <h3 class="font-semibold mb-1">Summe offener Beträge:</h3>
          <p class="text-xl font-bold text-blue-700"><span id="summeOffen">0.00</span> €</p>
        </div>
      </section>
    </div>

    <!-- Rechte Spalte - Tabelle -->
    <div class="md:col-span-2">
      <section class="bg-white border border-gray-200 p-4 rounded shadow">
        <div class="flex flex-wrap justify-between items-center mb-4">
          <h2 class="font-bold text-lg">📋 Ihre Briefe</h2>
          
          <div class="flex flex-wrap gap-2">
            <select id="filterKategorie" class="p-2 border rounded text-sm">
              <option value="">Alle Kategorien</option>
              <option>🟥 Gericht / Inkasso</option>
              <option>🟧 Versorger / Banken</option>
              <option>🟨 Behörden / Krankenkassen</option>
              <option>🟩 Werbung / Privat</option>
              <option>🏫 Schule / Beratung</option>
            </select>
            
            <select id="filterStatus" class="p-2 border rounded text-sm">
              <option value="">Alle Status</option>
              <option>📭 Ungeöffnet</option>
              <option>📖 Geöffnet</option>
              <option>📝 In Bearbeitung</option>
              <option>✅ Erledigt</option>
            </select>
            
            <button onclick="exportAllAsZip()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
              Exportieren
            </button>
          </div>
        </div>

        <div class="overflow-x-auto" id="druckbereich">
          <table class="w-full text-sm text-left border rounded" id="briefTable">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 border">Datum</th>
                <th class="p-2 border">Absender</th>
                <th class="p-2 border">Betreff</th>
                <th class="p-2 border">Betrag</th>
                <th class="p-2 border">Kategorie</th>
                <th class="p-2 border">Status</th>
                <th class="p-2 border">Aktionen</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <footer class="text-center text-sm text-gray-500 mt-10 pt-4 border-t">
    <p>Entwickelt von <a href="https://github.com/TimInTech" target="_blank" class="text-blue-600 hover:underline">TimInTech</a> | <a href="https://github.com/TimInTech/Brief-Dashboard" target="_blank" class="text-blue-600 hover:underline">GitHub Repository</a></p>
    <p class="mt-1">Alle Daten werden lokal in Ihrem Browser gespeichert</p>
  </footer>

  <script>
    // Globale Variablen
    const form = document.getElementById("briefForm");
    const tableBody = document.querySelector("#briefTable tbody");
    let eintraege = JSON.parse(localStorage.getItem("briefEintraege")) || [];

    // Initialisierung
    window.addEventListener("load", () => {
      loadData();
      setCurrentDate();
      loadDraft();
      setupAutoSave();
    });

    // Daten laden
    function loadData() {
      const savedData = localStorage.getItem("briefEintraege");
      if (savedData) eintraege = JSON.parse(savedData);
      renderTabelle();
      updateStatistik();
    }

    // Aktuelles Datum setzen
    function setCurrentDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('datum').value = today;
    }

    // Entwurf laden
    function loadDraft() {
      const draft = JSON.parse(localStorage.getItem("briefDraft"));
      if (draft) {
        if (draft.datum) document.getElementById('datum').value = draft.datum;
        if (draft.absender) document.getElementById('absender').value = draft.absender;
        if (draft.betreff) document.getElementById('betreff').value = draft.betreff;
        if (draft.betrag) document.getElementById('betrag').value = draft.betrag;
        if (draft.frist) document.getElementById('frist').value = draft.frist;
        if (draft.kategorie) document.getElementById('kategorie').value = draft.kategorie;
        if (draft.status) document.getElementById('status').value = draft.status;
        if (draft.notizen) document.getElementById('notizen').value = draft.notizen;
      }
    }

    // Auto-Save einrichten
    function setupAutoSave() {
      form.addEventListener("input", () => {
        const tempData = {
          datum: form.datum.value,
          absender: form.absender.value,
          betreff: form.betreff.value,
          betrag: form.betrag.value,
          frist: form.frist.value,
          kategorie: form.kategorie.value,
          status: form.status.value,
          notizen: form.notizen.value
        };
        localStorage.setItem("briefDraft", JSON.stringify(tempData));
      });
    }

    // Formularverarbeitung
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Dokumente verarbeiten
      const files = document.getElementById('dokumente').files;
      let dokumenteData = [];
      
      if (files.length > 0) {
        const allowedTypes = ['application/pdf'];
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.size > 5 * 1024 * 1024) {
            alert(`Datei ${file.name} ist zu groß (max. 5MB)`);
            continue;
          }

          if (!(allowedTypes.includes(file.type) || file.type.startsWith('image/'))) {
            alert(`Datei ${file.name} hat einen nicht unterstützten Dateityp. Erlaubt sind PDF und Bilder (JPG/PNG).`);
            continue;
          }

          const dataUrl = await readFileAsDataURL(file);
          dokumenteData.push({
            name: file.name,
            type: file.type,
            size: file.size,
            data: dataUrl
          });
        }
      }
      
      const neuerEintrag = {
        id: Date.now(),
        datum: form.datum.value || new Date().toISOString().split('T')[0],
        absender: form.absender.value || null,
        betreff: form.betreff.value || null,
        betrag: form.betrag.value || null,
        frist: form.frist.value || null,
        kategorie: form.kategorie.value || "🟩 Werbung / Privat",
        status: form.status.value || "📭 Ungeöffnet",
        notizen: form.notizen.value || null,
        dokumente: dokumenteData,
        erstelltAm: new Date().toISOString()
      };
      
      eintraege.push(neuerEintrag);
      saveAndRender();
      form.reset();
      setCurrentDate();
      localStorage.removeItem("briefDraft");
      alert("Eintrag erfolgreich gespeichert!");
    });

    // Datei als DataURL lesen
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Speichern und Anzeigen
    function saveAndRender() {
      localStorage.setItem("briefEintraege", JSON.stringify(eintraege));
      renderTabelle();
      updateStatistik();
    }

    // Tabelle rendern
    function renderTabelle() {
      const kategorieFilter = document.getElementById('filterKategorie').value;
      const statusFilter = document.getElementById('filterStatus').value;
      
      tableBody.innerHTML = "";
      
      // Sortiere nach Datum (neueste zuerst)
      const sortedEintraege = [...eintraege].sort((a, b) => new Date(b.datum) - new Date(a.datum));
      
      sortedEintraege.forEach((eintrag, index) => {
        if (kategorieFilter && eintrag.kategorie !== kategorieFilter) return;
        if (statusFilter && eintrag.status !== statusFilter) return;
        
        const row = document.createElement("tr");
        row.className = getPriorityClass(eintrag.kategorie);
        
        // Dokumenten-Icons
        let docIcons = '';
        if (eintrag.dokumente && eintrag.dokumente.length > 0) {
          const docCount = eintrag.dokumente.length;
          docIcons = `
            <div class="flex items-center">
              <span class="mr-1">${docCount}</span>
              ${eintrag.dokumente.some(d => d.type === 'application/pdf') ? '📄' : ''}
              ${eintrag.dokumente.some(d => d.type.startsWith('image/')) ? '🖼️' : ''}
            </div>
          `;
        }
        
        row.innerHTML = `
          <td class="p-2 border">${formatDate(eintrag.datum)}</td>
          <td class="p-2 border">${eintrag.absender || '-'}</td>
          <td class="p-2 border">${eintrag.betreff || '-'}</td>
          <td class="p-2 border text-right">${eintrag.betrag ? parseFloat(eintrag.betrag).toFixed(2) + " €" : "-"}</td>
          <td class="p-2 border">${eintrag.kategorie}</td>
          <td class="p-2 border">${eintrag.status}</td>
          <td class="p-2 border">
            <div class="flex gap-1">
              <button onclick="viewEntry(${index})" class="text-xs bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded">
                Ansehen
              </button>
              <button onclick="deleteEntry(${index})" class="text-xs bg-red-100 hover:bg-red-200 px-2 py-1 rounded">
                Löschen
              </button>
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Statistik aktualisieren
    function updateStatistik() {
      let catRed = 0, catOrange = 0, catYellow = 0, catGreen = 0, catSchool = 0;
      let statusOpen = 0, statusBearbeitung = 0, statusErledigt = 0;
      let summe = 0;

      eintraege.forEach(e => {
        // Kategorien zählen
        if (e.kategorie.includes('🟥')) catRed++;
        if (e.kategorie.includes('🟧')) catOrange++;
        if (e.kategorie.includes('🟨')) catYellow++;
        if (e.kategorie.includes('🟩')) catGreen++;
        if (e.kategorie.includes('🏫')) catSchool++;

        // Status zählen
        if (e.status.includes('📭') || e.status.includes('🔴')) statusOpen++;
        if (e.status.includes('📖') || e.status.includes('📝') || e.status.includes('🟡')) statusBearbeitung++;
        if (e.status.includes('✅') || e.status.includes('🟢')) statusErledigt++;

        // Summe offener Beträge
        if ((e.status.includes('📭') || e.status.includes('🔴') || e.status.includes('📖') || e.status.includes('📝') || e.status.includes('🟡')) && e.betrag) {
          const betrag = parseFloat(e.betrag);
          if (!isNaN(betrag)) summe += betrag;
        }
      });

      // Statistik aktualisieren
      document.getElementById('catRed').textContent = catRed;
      document.getElementById('catOrange').textContent = catOrange;
      document.getElementById('catYellow').textContent = catYellow;
      document.getElementById('catGreen').textContent = catGreen;
      document.getElementById('catSchool').textContent = catSchool;

      document.getElementById('statusOpen').textContent = statusOpen;
      document.getElementById('statusBearbeitung').textContent = statusBearbeitung;
      document.getElementById('statusErledigt').textContent = statusErledigt;
      document.getElementById('summeOffen').textContent = summe.toFixed(2);
    }

    // Eintrag anzeigen
    function viewEntry(index) {
      const eintrag = eintraege[index];
      let message = `Details:\nDatum: ${formatDate(eintrag.datum)}\nAbsender: ${eintrag.absender || '-'}\nBetreff: ${eintrag.betreff || '-'}\nBetrag: ${eintrag.betrag || '-'}\nStatus: ${eintrag.status}`;
      
      if (eintrag.notizen) {
        message += `\nNotizen: ${eintrag.notizen}`;
      }
      
      if (eintrag.dokumente && eintrag.dokumente.length > 0) {
        message += `\n\nAnhänge (${eintrag.dokumente.length}):`;
        eintrag.dokumente.forEach(doc => {
          message += `\n- ${doc.name} (${(doc.size / 1024).toFixed(1)} KB)`;
        });
      }
      
      alert(message);
    }

    // Eintrag löschen
    function deleteEntry(index) {
      if (confirm("Diesen Eintrag wirklich löschen?")) {
        eintraege.splice(index, 1);
        saveAndRender();
      }
    }

    // Export als ZIP
    function exportAllAsZip() {
      const zip = new JSZip();
      const dataFolder = zip.folder("briefdaten");
      
      // JSON mit allen Einträgen
      dataFolder.file("briefe.json", JSON.stringify(eintraege, null, 2));
      
      // Dokumente hinzufügen
      eintraege.forEach((eintrag, i) => {
        if (eintrag.dokumente && eintrag.dokumente.length > 0) {
          const entryFolder = dataFolder.folder(`eintrag_${i}`);
          eintrag.dokumente.forEach((doc, j) => {
            const base64Data = doc.data.split(',')[1];
            entryFolder.file(doc.name, base64Data, { base64: true });
          });
        }
      });
      
      // ZIP erstellen und herunterladen
      zip.generateAsync({ type: "blob" }).then(content => {
        saveAs(content, `briefe_export_${new Date().toISOString().split('T')[0]}.zip`);
        alert("Export erfolgreich erstellt!");
      });
    }

    // Hilfsfunktionen
    function formatDate(dateString) {
      if (!dateString) return "-";
      const date = new Date(dateString);
      return date.toLocaleDateString('de-DE');
    }

    function getPriorityClass(kategorie) {
      if (kategorie.includes('🟥')) return 'priority-high';
      if (kategorie.includes('🟧')) return 'priority-medium';
      if (kategorie.includes('🟨')) return 'priority-medium';
      return 'priority-low';
    }
  </script>
</body>
</html>
